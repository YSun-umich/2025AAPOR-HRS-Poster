---
title: "web screener prog"
author: "Yao Sun and Félix Báez-Santiago"
date: "2025-01-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,cache=TRUE, 
                      autodep=TRUE, cache.comments=FALSE,
                      message=FALSE, warning=FALSE,
                      fig.width=4.5, fig.height=3)
```

```{r}
library(caret)
library(dplyr)
library(tidyr)
library(tableone)
library(gtsummary)
library(pdftools)
```

```{r}
source_data <- read.csv("Screener_01.17.2025.csv") #This data set includes all responses collected from on and before 01.17.
```

### Clean the data structure and Drop ineligible cases
```{r}
#Drop Rows 1 and 2 that don't have relevant values
source_data <- source_data[-c(1, 2), ]

#Drop partial cases
###Check if "Finished" value is FALSE and False before running.
source_data <- source_data %>% filter(Finished != "False") 

###Check if "Q3." value is missing.
sum(is.na(source_data$Q3.))
sum(source_data$Q3. == "")
source_data$Q3.[source_data$Q3. == ""] <- NA
sum(is.na(source_data$Q3.))

source_data <- subset(source_data, !is.na(Q3.))
sum(is.na(source_data$Q3.))
```

```{r}
# Check if UserLanguage, Q1 and Q_Language are duplicated.
# source_data$UserLanguage == source_data$Q_Language

# source_data <- source_data %>%
#   mutate(UserLanguage = case_when(
#     UserLanguage == "EN" ~ "English",
#     UserLanguage == "ES" ~ "Español",
#     UserLanguage == "ZH-S" ~ "中文",
#     UserLanguage == "VI" ~ "Tiếng Việt",
#     UserLanguage == "KO" ~ "한국어"
#     ))

# check <- source_data$UserLanguage == source_data$Q1
# all(check)
```

### Split multiple values of Race into individual ones
```{r}
#Splits multiple races into individual rows, so each ID can have multiple rows if it has multiple races 
data_expanded <- source_data %>% 
  separate_rows(Q3., sep = ",\\s*") #Look for a comma, and Match zero or spaces following each comma
```

### Recode the race for Chinese and Korean Respondents
```{r}
data_expanded <- data_expanded |>
  mutate(
    Q3. =
      case_when(
      UserLanguage == "ZH-S" & Q3. == "White" ~ "Chinese",
      UserLanguage == "ZH-S" & Q3. == "Black or African American" ~ "Asian Indian",
      UserLanguage == "ZH-S" & Q3. == "Chinese" ~ "Filipino",
      UserLanguage == "ZH-S" & Q3. == "Asian Indian" ~ "Vietnamese",
      UserLanguage == "ZH-S" & Q3. == "Filipino" ~ "Korean",
      UserLanguage == "ZH-S" & Q3. == "Vietnamese" ~ "Japanese",
      UserLanguage == "ZH-S" & Q3. == "Korean" ~ "Some other Asian",
      UserLanguage == "ZH-S" & Q3. == "Japanese" ~ "White",
      UserLanguage == "ZH-S" & Q3. == "Some other Asian" ~ "Black or African American",
      UserLanguage == "ZH-S" & Q3. == "American Indian or Alaska Native" ~ "American Indian or Alaska Native",
      UserLanguage == "ZH-S" & Q3. == "Native Hawaiian or Other Pacific Islander" ~ "Native Hawaiian or Other Pacific Islander",
      UserLanguage == "ZH-S" & Q3. == "Some other race" ~ "Some other race",
      UserLanguage == "KO" & Q3. == "White" ~ "Korean",
      UserLanguage == "KO" & Q3. == "Black or African American" ~ "Chinese",
      UserLanguage == "KO" & Q3. == "Chinese" ~ "Asian Indian",
      UserLanguage == "KO" & Q3. == "Asian Indian" ~ "Filipino",
      UserLanguage == "KO" & Q3. == "Filipino" ~ "Vietnamese",
      UserLanguage == "KO" & Q3. == "Vietnamese" ~ "Japanese",
      UserLanguage == "KO" & Q3. == "Korean" ~ "Some other Asian",
      UserLanguage == "KO" & Q3. == "Japanese" ~ "White",
      UserLanguage == "KO" & Q3. == "Some other Asian" ~ "Black or African American",
      UserLanguage == "KO" & Q3. == "American Indian or Alaska Native" ~ "American Indian or Alaska Native",
      UserLanguage == "KO" & Q3. == "Native Hawaiian or Other Pacific Islander" ~ "Native Hawaiian or Other Pacific Islander",
      UserLanguage == "KO" & Q3. == "Some other race" ~ "Some other race",
      TRUE ~ Q3.
  ))
```

### Create dummy variable for each race
```{r}
#One-hot encode each race, grouping by id to keep one row per id
data_one_hot <- data_expanded %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = Q3., values_from = value, values_fill = list(value = 0)) #Expanding race categories into columns, filling missing combinations with 0.
dim(data_one_hot)
dim(data_expanded)

races <- c("White", "Black or African American", "Chinese", "Asian Indian", "Filipino", "Vietnamese", "Korean", "Japanese", "Some other Asian", "American Indian or Alaska Native", "Native Hawaiian or Other Pacific Islander", "Some other race")

#Detects race columns that are missing and adds columns of 0s
Missing <- setdiff(races, names(data_one_hot))  # Find names of missing columns
data_one_hot[Missing] <- 0
#Check race column order
print(colnames(data_one_hot)[43:54])
#Reorder columns for consistency
data_one_hot<- data_one_hot[,c(colnames(data_one_hot)[1:42], "White", "Black or African American", "Chinese", "Asian Indian", "Filipino", "Vietnamese", "Korean", "Japanese", "Some other Asian", "American Indian or Alaska Native", "Native Hawaiian or Other Pacific Islander", "Some other race")]
#check race column order
print(colnames(data_one_hot)[43:54])
```

### Split multiple values of davices into individual ones and Create dummy variable for each device option
```{r}
#Q6 Separate multiple device values into individual rows
data_expanded_Q6 <- data_one_hot %>% 
  separate_rows(Q6., sep = ",\\s*") #Splits multiple device values into individual rows, so each ID can have multiple rows if it has multiple device values

#One-hot encode each race, grouping by id to keep one row per id
data_one_hot <- data_expanded_Q6 

data_one_hot <- data_one_hot %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = Q6., values_from = value, values_fill = list(value = 0)) #Expanding race categories into columns, filling missing combinations with 0.

#check columns
print(colnames(data_one_hot)[1:53])
print(colnames(data_one_hot)[54:56])

#Check missing device columns and add column of 0
devices <- c("Smartphone\n", "Computer\n", "Tablet\n", "None")
Missing_dev <- setdiff(devices, names(data_one_hot))  # Find names of missing columns
data_one_hot[Missing_dev] <- 0

data_one_hot<- data_one_hot[,c(colnames(data_one_hot)[1:53],"Smartphone\n", "Computer\n", "Tablet\n", "None")]

print(colnames(data_one_hot)[54:57])
#check device column order
data_one_hot[,50:57]

#drop empty columns
drops <- c("RecipientLastName", "RecipientFirstName", "RecipientEmail", "ExternalReference", "Q2_1.", "Q2_2.", "Q2.1", "Q2_1", "Q3A_", "Q3B_", "UserLanguage", "Q_Language")
cleaned_data <- data_one_hot[ , !(names(data_one_hot) %in% drops)]
```

```{r}
#Restore correct Q3. values to cleaned data
# re_source_data <- source_data |>
#   mutate(
#     Q3. =
#       case_when(
#       UserLanguage == "ZH-S" & Q3. == "White" ~ "Chinese",
#       UserLanguage == "ZH-S" & Q3. == "Black or African American" ~ "Asian Indian",
#       UserLanguage == "ZH-S" & Q3. == "Chinese" ~ "Filipino",
#       UserLanguage == "ZH-S" & Q3. == "Asian Indian" ~ "Vietnamese",
#       UserLanguage == "ZH-S" & Q3. == "Filipino" ~ "Korean",
#       UserLanguage == "ZH-S" & Q3. == "Vietnamese" ~ "Japanese",
#       UserLanguage == "ZH-S" & Q3. == "Korean" ~ "Some other Asian",
#       UserLanguage == "ZH-S" & Q3. == "Japanese" ~ "White",
#       UserLanguage == "ZH-S" & Q3. == "Some other Asian" ~ "Black or African American",
#       UserLanguage == "ZH-S" & Q3. == "American Indian or Alaska Native" ~ "American Indian or Alaska Native",
#       UserLanguage == "ZH-S" & Q3. == "Native Hawaiian or Other Pacific Islander" ~ "Native Hawaiian or Other Pacific Islander",
#       UserLanguage == "ZH-S" & Q3. == "Some other race" ~ "Some other race",
#       UserLanguage == "KO" & Q3. == "White" ~ "Korean",
#       UserLanguage == "KO" & Q3. == "Black or African American" ~ "Chinese",
#       UserLanguage == "KO" & Q3. == "Chinese" ~ "Asian Indian",
#       UserLanguage == "KO" & Q3. == "Asian Indian" ~ "Filipino",
#       UserLanguage == "KO" & Q3. == "Filipino" ~ "Vietnamese",
#       UserLanguage == "KO" & Q3. == "Vietnamese" ~ "Japanese",
#       UserLanguage == "KO" & Q3. == "Korean" ~ "Some other Asian",
#       UserLanguage == "KO" & Q3. == "Japanese" ~ "White",
#       UserLanguage == "KO" & Q3. == "Some other Asian" ~ "Black or African American",
#       UserLanguage == "KO" & Q3. == "American Indian or Alaska Native" ~ "American Indian or Alaska Native",
#       UserLanguage == "KO" & Q3. == "Native Hawaiian or Other Pacific Islander" ~ "Native Hawaiian or Other Pacific Islander",
#       UserLanguage == "KO" & Q3. == "Some other race" ~ "Some other race",
#       TRUE ~ Q3.
#   ))

#cleaned_data$Q3. = re_source_data$Q3.

#export as CSV
write.csv(cleaned_data, "Screener_Recoded_01.17.2025.csv")
```

### Now See data_one_hot for the data set with other dummy variables.
```{r}
setdiff(names(data_one_hot), names(cleaned_data)) #Variables that exist in data_one_hot but not in cleaned data
```

### Create summary tables using GTsummary function. 
```{r}
# Create 10-year age categories
new_cleaned_data <- cleaned_data
new_cleaned_data$Q2 <- as.numeric(as.character(new_cleaned_data$Q2))

new_cleaned_data$age_group <- cut(
  new_cleaned_data$Q2,  # Replace 'my_data' with the actual name of your data frame
  breaks = seq(40, 120, by = 10),  # Define 10-year breaks
  right = FALSE,  # Left-closed intervals, e.g., [40, 50)
  labels = paste(seq(40, 110, by = 10), "-", seq(49, 119, by = 10))  # 10-year range labels
)

# Create summary tables, include n and percentage
new_cleaned_data %>%
  select(Q1, age_group, Q4., Q7., Q5.) %>%
  tbl_summary(
    statistic = list(all_categorical() ~ "{n} ({p}%)"),  # Show counts and percentages
    label = list(
      Q1 ~ "Preferred Language",
      Q4. ~ "Gender",
      age_group ~ "Age Group",
      Q7. ~ "State of Residence",
      Q5. ~ "Education Level"
      ),
    missing = "no"  # Ignore missing values (optional)
  )

new_cleaned_data %>%
  select(White, `Black or African American`, Chinese, `Asian Indian`, Filipino, Vietnamese, Korean, Japanese, `Some other Asian`, `American Indian or Alaska Native`, `Native Hawaiian or Other Pacific Islander`, `Some other race`) %>%
  tbl_summary(statistic = list(all_categorical() ~ "{n}")) 

new_cleaned_data %>%
  select(`Smartphone\n`, `Computer\n`, `Tablet\n`, None) %>%
  tbl_summary(statistic = list(all_categorical() ~ "{n}")) 
```

```{r}
# Specify the paths to the PDFs you want to merge
pdfs <- c("Screener Summary table.pdf", "Screener Summary table(device).pdf", "Screener Summary table(race).pdf")

# Specify the output merged PDF file
output_pdf <- "merged_output.pdf"

# Merge the PDFs
pdf_combine(pdfs, output_pdf)

```


